databases:
  - name: inspection-db
    plan: free
    databaseName: inspection
    user: inspection
    ipAllowList: []

services:
  # ── Backend (Flask API) ───────────────────────────────────
  - type: web
    name: inspection-api
    runtime: docker
    repo: https://github.com/AliAliAhmad/inspection-system
    rootDir: .
    dockerfilePath: ./Dockerfile
    plan: starter
    region: oregon
    healthCheckPath: /health
    disk:
      name: uploads
      mountPath: /app/instance/uploads
      sizeGB: 1
    envVars:
      - key: SECRET_KEY
        generateValue: true
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: DATABASE_URL
        fromDatabase:
          name: inspection-db
          property: connectionString
      - key: FLASK_ENV
        value: production
      - key: CORS_ORIGINS
        value: https://inspection-web.onrender.com,https://inspection-web-*.onrender.com
      - key: GUNICORN_WORKERS
        value: "2"
      - key: GUNICORN_THREADS
        value: "4"
      - key: LOG_LEVEL
        value: INFO

  # ── Frontend (React Static Site) ──────────────────────────
  - type: web
    name: inspection-web
    runtime: static
    repo: https://github.com/AliAliAhmad/inspection-system
    rootDir: frontend
    buildCommand: |
      npm install -g pnpm@9 &&
      pnpm install --no-frozen-lockfile &&
      VITE_API_URL=https://inspection-api-o3hz.onrender.com pnpm --filter @inspection/web build
    staticPublishPath: apps/web/dist
    pullRequestPreviewsEnabled: true
    headers:
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: Content-Security-Policy
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://inspection-api-o3hz.onrender.com; frame-ancestors 'self';"
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: NODE_VERSION
        value: "20"
      - key: VITE_API_URL
        value: https://inspection-api-o3hz.onrender.com
      - key: VITE_APP_TITLE
        value: Inspection System
